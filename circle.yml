machine:
  environment:
    PATH: "${HOME}/bin:${HOME}/vagrant/bin:${PATH}"
    PACKER_URL: "https://dl.bintray.com/mitchellh/packer/packer_0.8.6_linux_amd64.zip"
    PACKER_SHA256SUM: "2f1ca794e51de831ace30792ab0886aca516bf6b407f6027e816ba7ca79703b5"
    VAGRANT_URL: "https://dl.bintray.com/mitchellh/vagrant/vagrant_1.7.4_x86_64.deb"
    VAGRANT_SHA256SUM: "dcd2c2b5d7ae2183d82b8b363979901474ba8d2006410576ada89d7fa7668336"

dependencies:
  cache_directories:
    - "~/vagrant"
    - "~/bin"
  override:
    - |
      if [ ! -d "${HOME}/vagrant" ]; then
        curl -Lo vagrant.deb "${VAGRANT_URL}"
        sha256sum vagrant.deb
        echo "${VAGRANT_SHA256SUM}  vagrant.deb" | sha256sum -c || exit 1
        sudo dpkg -i vagrant.deb
        cp -aR /opt/vagrant "${HOME}/vagrant"
      fi
    - vagrant version
    - cp vagrantfile.template Vagrantfile
    - |
      if [ ! -e "${HOME}/bin/packer" ]; then
        curl -Lo packer.zip "${PACKER_URL}"
        echo "${PACKER_SHA256SUM}  packer.zip" | sha256sum -c || exit 1
        unzip -d ~/bin packer.zip
      fi
    - packer version

test:
  override:
    - find scripts -name '*.sh' -print0 | xargs -0 sh -n
    - vagrant version
    - packer validate template.json

deployment:
  release:
    tag: /[0-9]+\.[0-9]+\.[0-9]+/
    commands:
      - |
        sed -i.orig "s/0.0.0/${CIRCLE_TAG}/" template.json
        diff -u template.json{.orig,} || :
      - packer push template.json
